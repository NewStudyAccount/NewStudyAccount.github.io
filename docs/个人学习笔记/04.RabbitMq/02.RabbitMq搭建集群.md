# RabbitMq搭建集群

## docker-compose文件

```yaml
version: '3'
services:
  rabbitmq1:
    image: rabbitmq
    ports:
      - "15672:15672"
      - "5672:5672"
    hostname: rabbitmq1
    container_name: rabbitmq1
    volumes:
      - ./data/rabbitmqCluster/rabbitmq1:/var/lib/rabbitmq
    environment:
      - RABBITMQ_ERLANG_COOKIE=rabbitcookie
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    restart: always

  rabbitmq2:
    image: rabbitmq
    ports:
      - "15673:15672"
      - "5673:5672"
    hostname: rabbitmq2
    container_name: rabbitmq2
    volumes:
      - ./data/rabbitmqCluster/rabbitmq1:/var/lib/rabbitmq
    environment:
      - RABBITMQ_ERLANG_COOKIE=rabbitcookie
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    restart: always


  rabbitmq3:
    image: rabbitmq
    ports:
      - "15674:15672"
      - "5674:5672"
    hostname: rabbitmq3
    container_name: rabbitmq3
    volumes:
      - ./data/rabbitmqCluster/rabbitmq1:/var/lib/rabbitmq
    environment:
      - RABBITMQ_ERLANG_COOKIE=rabbitcookie
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=admin
    restart: always

```



## 开启管理页面与接入节点



**主节点执行：**

```bash
docker exec rabbitmq1 /bin/bash -c 'rabbitmqctl stop_app'
docker exec rabbitmq1 /bin/bash -c 'rabbitmqctl reset'
docker exec rabbitmq1 /bin/bash -c 'rabbitmqctl start_app'
docker exec rabbitmq1 /bin/bash -c 'rabbitmq-plugins enable rabbitmq_management'
docker exec rabbitmq1 /bin/bash -c 'echo management_agent.disable_metrics_collector = false > /etc/rabbitmq/conf.d//management_agent.disable_metrics_collector.conf'
```



**节点2**

```bash
## 加入主节点
docker exec rabbitmq2 /bin/bash -c 'rabbitmqctl stop_app'
docker exec rabbitmq2 /bin/bash -c 'rabbitmqctl reset'
# --ram表示加入的角色是内存节点， 不加该参数，表示数据节点
docker exec rabbitmq2 /bin/bash -c 'rabbitmqctl join_cluster --ram rabbit@rabbitmq1'
docker exec rabbitmq2 /bin/bash -c 'rabbitmqctl start_app'
docker exec rabbitmq2 /bin/bash -c 'rabbitmq-plugins enable rabbitmq_management'
docker exec rabbitmq2 /bin/bash -c 'echo management_agent.disable_metrics_collector = false > /etc/rabbitmq/conf.d//management_agent.disable_metrics_collector.conf'
```



**节点3**

```bash
## 加入主节点
docker exec rabbitmq3 /bin/bash -c 'rabbitmqctl stop_app'
docker exec rabbitmq3 /bin/bash -c 'rabbitmqctl reset'
# --ram表示加入的角色是内存节点， 不加该参数，表示数据节点
docker exec rabbitmq3 /bin/bash -c 'rabbitmqctl join_cluster --ram rabbit@rabbitmq1'
docker exec rabbitmq3 /bin/bash -c 'rabbitmqctl start_app'
docker exec rabbitmq3 /bin/bash -c 'rabbitmq-plugins enable rabbitmq_management'
docker exec rabbitmq3 /bin/bash -c 'echo management_agent.disable_metrics_collector = false > /etc/rabbitmq/conf.d//management_agent.disable_metrics_collector.conf'
```



## 重启所有容器

